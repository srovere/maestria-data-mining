---
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
output: pdf_document
title: 'Visualización de la información: Trabajo Práctico nº 1'
subtitle: Integridad visual
author: 
  - Santiago Rovere (srovere@gmail.com), Facultad de Ciencias Exactas y Naturales (UBA)
lang: es
---

# 1. Análisis de gráficos de medios locales.

# 2. La peor visualización del mundo

```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, results=FALSE }
# Borrar variables del ambiente
rm(list = objects())

# Carga de paquetes necesarios para hacer los gráficos
require(Cairo)
require(ggrepel)
require(sf)
require(tidyverse)

# Uso de Cairo para renderizar los gráficos
options(bitmapType = "cairo")

# Cargar shapes de provincias y departamentos
provincias    <- base::readRDS("shapes/gadm36_ARG_1_sf.rds")
departamentos <- sf::st_read(dsn = "shapes", layer = "ign_departamento")

# Cargar conjunto de datos
datos <- readr::read_delim(file = "dataset_incendios.csv", delim = ";") %>%
  dplyr::mutate(IN1 = paste0(provincia_id, departamento_id)) %>%
  dplyr::select(`año_inicial`, `año_final`, IN1, provincia, sup_afectada) %>%
  dplyr::rename(ano_inicio = `año_inicial`, ano_fin = `año_final`) %>%
  dplyr::filter(! is.na(sup_afectada))

# Definir categoria y color a cada dato de superficie afectada
intervalos <- c(-Inf, quantile(datos$sup_afectada, probs = seq(0.2, 0.8, 0.2)), Inf)
colores    <- c('#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00')
etiquetas  <- purrr::map(
    .x = seq(from = 1, to = length(intervalos) - 1, by = 1),
    .f = function(pos) {
      desde <- intervalos[pos]
      hasta <- intervalos[pos+1]
      if (is.infinite(desde)) {
        return (sprintf("Menos de %.2f Has", hasta))
      } else if (is.infinite(hasta)) {
        return (sprintf("Más de %.2f Has", desde))
      } else {
        return (sprintf("De %.2f a %.2f Has", desde, hasta))
      }
    }
  ) %>% unlist()

# Geolocalizar conjunto de datos y asignar categoria y color segun superficie afectada
datos.geolocalizados <- departamentos %>%
  dplyr::inner_join(datos, by = c("IN1")) %>%
  dplyr::select(IN1, provincia, sup_afectada) %>%
  dplyr::mutate(categoria = cut(x = sup_afectada, breaks = intervalos, labels = etiquetas))

# Generar resumen por provincia
resumen <- sf::st_set_geometry(datos.geolocalizados, NULL) %>%
  dplyr::group_by(provincia) %>%
  dplyr::summarise(area_afectada = sum(sup_afectada)) %>%
  dplyr::mutate(total = sum(area_afectada), porcentaje = 100*area_afectada/total) %>%
  dplyr::arrange(dplyr::desc(porcentaje)) 
otras.provincias <- resumen %>%
  dplyr::filter(porcentaje < 1) %>%
  dplyr::summarise(provincia = "Otras", porcentaje = sum(porcentaje), area_afectada = sum(area_afectada))
resumen.truncado <- resumen %>%
  dplyr::filter(porcentaje >= 1) %>%
  dplyr::bind_rows(otras.provincias)

# Generar serie temporal
serie.temporal <- dplyr::bind_rows(
  dplyr::distinct(datos, ano_inicio, IN1, sup_afectada) %>%
    dplyr::rename(ano = ano_inicio),
  dplyr::distinct(dplyr::filter(datos, ano_fin > ano_inicio), ano_fin, IN1, sup_afectada) %>%
    dplyr::rename(ano = ano_fin)
) %>% dplyr::group_by(ano) %>%
  dplyr::summarise(area_afectada = sum(sup_afectada))
```

```{r, echo=FALSE, warnings=FALSE, message=FALSE, fig.width=10, fig.height=10 }
# Generar inset 1 indicando evolucion temporal de areas incendiadas
inset1 <- ggplot2::ggplot(data = serie.temporal) +
  ggplot2::geom_point(mapping = ggplot2::aes(x = ano, y = area_afectada, size = area_afectada),
                      color = "red", fill = alpha("orange", 0.3), alpha = 0.7) +
  ggplot2::labs(x = "", y = "", title = "Evolución temporal de área afectada", size = "Área afectada") +
  ggplot2::theme_light() + 
  ggplot2::theme(
    plot.title = ggplot2::element_text(hjust = 0.5, size = 12),
    legend.position = "bottom"
  )
inset.tibble.1 <- tibble::tibble(x = 0.98, y = 0.90, plot = list(inset1))

# Generar inset 2 indicando porcentaje de area que le corresponde a cada provincia y la superficie total
min.porcentaje <- min(resumen.truncado$porcentaje)
max.porcentaje <- max(resumen.truncado$porcentaje)
inset2 <- ggplot2::ggplot(data = resumen.truncado) +
  ggplot2::geom_segment(mapping = ggplot2::aes(x = provincia, xend = provincia, y = min(porcentaje), yend = porcentaje)) +
  ggplot2::geom_point(mapping = ggplot2::aes(x = provincia, y = porcentaje),
                      size = 3, color = "red", fill = alpha("orange", 0.3), alpha = 0.7, shape = 21, stroke = 2) +
  ggplot2::labs(x = "", y = "", title = "Distribución provincial de área afectada") +
  ggplot2::scale_y_continuous(limits = c(min.porcentaje, max.porcentaje),
                              breaks = seq(from = min.porcentaje, to = max.porcentaje, 
                                           by = (max.porcentaje - min.porcentaje) / 10)) +
  ggplot2::theme_light() + 
  ggplot2::theme(
    plot.title = ggplot2::element_text(hjust = 0.5, size = 12),
    plot.subtitle = ggplot2::element_text(hjust = 0.5, size = 10),
    legend.position = 'none',
    axis.text.x = ggplot2::element_text(angle = 90)
  )

# Generar tibble con insets
inset.tibble <- tibble::tibble(
  x = c(0.98, 0.98), y = c(0.98, 0.07), 
  vp.width = c(0.4, 0.6), vp.height = c(0.45, 0.45),
  plot = list(inset1, inset2)
)

# Dibujar mapa
ggplot2::ggplot() +
  ggpmisc::geom_plot_npc(data = inset.tibble, 
                         mapping = ggplot2::aes(npcx = x, npcy = y, label = plot, vp.width = vp.width, vp.height = vp.height)) +
  ggplot2::geom_sf(data = provincias, colour = "black", fill = "#dbdbdb", size = 0.1) +
  ggplot2::geom_sf(data = datos.geolocalizados, colour = NA,
                   mapping = ggplot2::aes(fill = categoria)) +
  ggplot2::annotate(geom = "text", x = -38, y = -61, parse = TRUE,
                    label = "paste(bold(\"Fuente:\"), \" https://datos.gob.ar/dataset/ambiente-incendios-forestales\")") +
  ggplot2::coord_sf(xlim = c(-80, -25), ylim = c(-60, -20)) +
  ggplot2::labs(x = "", y = "", title = "Distribución espacial de incendios forestales",
                subtitle = "Superficie afectada por incendios entre 2011 y 2016") +
  ggplot2::scale_fill_manual(name = "Superficie afectada", values = colores, labels = etiquetas) +
  ggplot2::theme_bw() +
  ggplot2::theme(
    plot.title = ggplot2::element_text(vjust = -15, hjust = 0.2),
    plot.subtitle = ggplot2::element_text(vjust = -20, hjust = 0.2),
    panel.grid.major = ggplot2::element_blank(),
    axis.text.x = ggplot2::element_blank(),
    axis.ticks.x = ggplot2::element_blank(),
    axis.text.y = ggplot2::element_blank(),
    axis.ticks.y = ggplot2::element_blank(),
    strip.text.x = ggplot2::element_blank(),
    strip.background = ggplot2::element_rect(colour = "white", fill = "white"),
    legend.position = c(0.11, 0.11),
    legend.background = ggplot2::element_rect(fill = "grey90", size = 0.1, linetype = "solid", colour = "black")
  )
```

En gráfico anterior está basada en el mismo conjunto de datos que el TP nº1. Pretende presentar distintas dimensiones correspondientes a la problemática de los *incendios forestales* dentro de la República Argentina. Los datos analizados corresponden al período 2011-2016 y fueron extraídos de https://datos.gob.ar/dataset/ambiente-incendios-forestales. Sin embargo, a diferencia del trabajo práctico anterior se introdujeron algunos cambios para *empobrecer* la visualización en distintos aspectos de acuerdo a lo solicitado en el enunciado.

En el caso del mapa, se ha modificado la escala de colores que anteriormente era secuencial y representaba mayores áreas afectadas con colores rojos oscuros y menores áreas con con amarillos claros. Al introducir una escala secuencial, resulta difícil establecer una comparación rápida de las áreas afectadas sin tener que recurrir constantemente a las referencias. Más aún, el color rojo que resulta natural asociarlo a situaciones de alarma, se corresponde con la categoría de menor área afectada.

Siguiendo con el *inset superior derecho*, se muestra un gráfico de evolución de área afectada. El primer problema del gráfico es que no indica las unidades en que se expresa el área afectada. Además, presenta un sobredimensionamiento en la representación del área afectada. Esto se debe a que el valor del área afectada se muestra como una distancia de un punto en el eje Y, pero también mediante el tamaño del punto. Evaluar la distancia sin un segmento de recta también resulta una complicación adicional.

Finalmente, en el *inset inferior derecho* se observa la distribución de área afectada por provincia para todo el período. En primer lugar, no se indica en ningún lado que los valores son para todo el período ni las unidades de representación del área (que son porcentajes respecto del área total). Además, se observa que el punto mínimo (Otras) no tiene longitud a pesar de tener asociado un porcentaje de 1,27%. Esto introduce un pequeño factor de mentira cuando se intenta comparar las diferencias entre datos y diferencias entre longitudes. Por último, se podría agregar que la escala del eje Y resulta totalmente inapropiada y difícil de interpretar.