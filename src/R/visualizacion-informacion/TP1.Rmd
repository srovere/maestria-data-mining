---
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
output: pdf_document
title: 'Visualización de la información: Trabajo Práctico nº 1'
subtitle: Superficie afectada por incendios
author: 
  - Santiago Rovere (srovere@gmail.com), Facultad de Ingeniería, Universidad de Buenos Aires
lang: es
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, results=FALSE }
# Borrar variables del ambiente
rm(list = objects())

# Carga de paquetes necesarios para hacer los gráficos
require(Cairo)
require(ggrepel)
require(sf)
require(tidyverse)

# Uso de Cairo para renderizar los gráficos
options(bitmapType = "cairo")

# Cargar shapes de provincias y departamentos
provincias    <- base::readRDS("shapes/gadm36_ARG_1_sf.rds")
departamentos <- sf::st_read(dsn = "shapes", layer = "ign_departamento")

# Cargar conjunto de datos
datos <- readr::read_delim(file = "dataset_incendios.csv", delim = ";") %>%
  dplyr::mutate(IN1 = paste0(provincia_id, departamento_id)) %>%
  dplyr::select(IN1, provincia, sup_afectada) %>%
  dplyr::filter(! is.na(sup_afectada))

# Definir categoria y color a cada dato de superficie afectada
intervalos <- c(-Inf, quantile(datos$sup_afectada, probs = seq(0.2, 0.8, 0.2)), Inf)
colores    <- c('#ffffb2','#fecc5c','#fd8d3c','#f03b20','#bd0026')
etiquetas  <- purrr::map(
    .x = seq(from = 1, to = length(intervalos) - 1, by = 1),
    .f = function(pos) {
      desde <- intervalos[pos]
      hasta <- intervalos[pos+1]
      if (is.infinite(desde)) {
        return (sprintf("Menos de %.2f Has (Q%d)", hasta, pos))
      } else if (is.infinite(hasta)) {
        return (sprintf("Más de %.2f Has (Q%d)", desde, pos))
      } else {
        return (sprintf("De %.2f a %.2f Has (Q%d)", desde, hasta, pos))
      }
    }
  ) %>% unlist()

# Geolocalizar conjunto de datos y asignar categoria y color segun superficie afectada
datos.geolocalizados <- departamentos %>%
  dplyr::inner_join(datos, by = c("IN1")) %>%
  dplyr::select(IN1, provincia, sup_afectada) %>%
  dplyr::mutate(categoria = cut(x = sup_afectada, breaks = intervalos, labels = etiquetas))

# Generar resumen por provincia
resumen <- sf::st_set_geometry(datos.geolocalizados, NULL) %>%
  dplyr::group_by(provincia) %>%
  dplyr::summarise(area_afectada = sum(sup_afectada)) %>%
  dplyr::mutate(total = sum(area_afectada), porcentaje = 100*area_afectada/total) %>%
  dplyr::arrange(dplyr::desc(porcentaje)) 
otras.provincias <- resumen %>%
  dplyr::filter(porcentaje < 1) %>%
  dplyr::summarise(provincia = "Otras", porcentaje = sum(porcentaje), area_afectada = sum(area_afectada))
resumen.truncado <- resumen %>%
  dplyr::filter(porcentaje >= 1) %>%
  dplyr::bind_rows(otras.provincias) %>%
  dplyr::mutate(provincia = factor(provincia, levels = provincia))
```

```{r, echo=FALSE, warnings=FALSE, message=FALSE, fig.width=10, fig.height=10 }
# Generar inset indicando porcentaje de area que le corresponde a cada provincia y la superficie total
inset <- ggplot2::ggplot(data = resumen.truncado) +
  ggplot2::geom_bar(mapping = ggplot2::aes(x = provincia, y = porcentaje, fill = provincia), stat = 'identity') +
  ggrepel::geom_label_repel(mapping = ggplot2::aes(x = provincia, y = porcentaje, 
                                                   label = sprintf("%.2f Has", area_afectada)),
                            nudge_x = 0, nudge_y = 10, size = 3) +
  ggplot2::labs(x = "", y = "Porcentaje", title = "Distribución de área afectada",
                subtitle = "Porcentaje de área respecto del total afectado") +
  ggplot2::theme_light() + 
  ggplot2::theme(
    plot.title = ggplot2::element_text(hjust = 0.5),
    plot.subtitle = ggplot2::element_text(hjust = 0.5),
    axis.text.x = ggplot2::element_text(angle = 45, margin = margin(15,0,0,0)),
    legend.position = 'none'
  )
inset.tibble <- tibble::tibble(x = 0.98, y = 0, plot = list(inset))

# Dibujar mapa
ggplot2::ggplot() +
  ggpmisc::geom_plot_npc(data = inset.tibble, 
                         mapping = ggplot2::aes(npcx = x, npcy = y, label = plot, vp.width = 0.6, vp.height = 0.5)) +
  ggplot2::geom_sf(data = provincias, colour = "black", fill = "#dbdbdb", size = 0.5) +
  ggplot2::geom_sf(data = datos.geolocalizados, colour = NA,
                   mapping = ggplot2::aes(fill = categoria)) +
  ggplot2::coord_sf(xlim = c(-75, -25)) +
  ggplot2::scale_fill_manual(name = "Superficie afectada", values = colores, labels = etiquetas) +
  ggplot2::theme_bw() +
  ggplot2::theme(
    strip.text.x = element_blank(),
    strip.background = element_rect(colour = "white", fill = "white"),
    legend.position = c(0.85, 0.85),
    legend.background = element_rect(fill = "grey80", size = 0.5, linetype = "solid", colour = "black")
  )
```

