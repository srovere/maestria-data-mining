---
title: "Data Mining: Trabajo Práctico nº 1"
subtitle: "Análisis de set de datos de Precios Claros"
author:
- Santiago Rovere (srovere@gmail.com), Facultad de Ingeniería, Universidad de Buenos Aires
- Javier Quinteros (jaqbase-dmkm@yahoo.com.ar), Universidad Argentina de la Empresa
date: '`r format(Sys.Date(), "%d de %B de %Y")`'
output:
  html_document:
    number_sections: yes
  pdf_document:
    number_sections: yes
  html_notebook:
    number_sections: yes
header-includes: \usepackage{float}
lang: es
---

```{r, echo=FALSE, warnings=FALSE, message=FALSE }
# Borrar bariables del ambiente
rm(list = objects())

# Carga de paquetes necesarios para hacer los gráficos
require(Cairo)
require(ggplot2)
require(gridExtra)
require(knitr)
require(sf)

# Uso de Cairo para renderizar los gráficos
options(bitmapType = "cairo")

# Ubicar los gráficos en el lugar donde aparece el código
knitr::opts_chunk$set(fig.pos = "H", collapse = TRUE)

# Carga de variables necesarias para realizar el informe
load(file = paste0("input/PreciosClaros.RData"))
load(file = paste0("output/GraficosPreparacion.RData"))
load(file = paste0("output/Informe.RData"))
```

# Introducción

El presente trabajo se basa en la exploración y análisis de un conjunto de datos extraído del la aplicación **Precios Claros** [1]. Dichos datos fueron extraídos mediante un proceso de relevamiento automático utilizando la técnica de web crawling [2]. Este proceso consistió en la en la generación de consultas a la página web mediante un script programado en *Python*. Cada medición tomó 3 semanas aproximadamente debido a la gran cantidad de datos disponibles y la cantidad máxima de consultas por día que se pueden hacer al sitio sin ser bloqueado. Sea realizaron un total de 10 mediciones.

Posteriormente, este conjunto de datos fue introducido en una base de datos MongoDB a fin de poder manejar más cómodamente las consultas. El set de datos inicial es el siguiente:

   tabla      | descripción                                                       | cantidad de datos
   -----------|-------------------------------------------------------------------|------------------
    productos | productos relevados por la aplicación                             | 1.000
   sucursales | sucursales relevadas en los distintos barrios de CABA             | 837
      precios | precios por producto y sucursal para cada una de las mediciones   | + 1,5 millones
      
Este documento se organiza de la siguiente manera: en la sección *2* se presentarán los objetivos de este estudio en forma de preguntas a responder; en la sección *3* se detallará el proceso de preparación de datos que se realizó a fin de poder llevar a cabo los análisis de la sección *4*; finalmente, en la sección *5* se elaborarán las conclusiones finales del trabajo proponiendo algunas posibles líneas de trabajo futuro.

# Objetivo

En presente trabajo se propone responder una serie de preguntas organizadas en 3 categorías:

* Análisis exploratorio inicial
  - ¿Cómo es la distribución espacial de sucursales de acuerdo a la cantidad y tipo de sucursal?
  - ¿Cuál es la cantidad de datos relevados por barrio/comuna? ¿Existe alguna relación con la cantidad de sucursales relevadas?
  - ¿Son uniformes en cuanto a duración los períodos de medición? ¿Y con respecto a la cantidad de datos?

* Ranking de precios 
  - ¿Cuáles son las sucursales con precios más altos y más bajos a lo largo de todo el período?
  - ¿Cuáles son las empresas con precios más altos y más bajos?
  - ¿Cuáles son las comunas con precios más altos y más bajos?
  
* Evolución temporal de precios
  - ¿Es consistente la evolución de precios con los datos del IPC informado por el Gobierno de la Ciudad de Buenos Aires? ¿Hay alguna diferencia según el tipo de sucursal?
  - ¿Cuál es la evolución porcentual de precios por comuna?
  - ¿Cuál fue le evolución de precios según la empresa?
  - ¿Cuáles fueron los productos cuya evolución fue máxima y mínima? ¿Y los que fueron más estables?
  
# Preparación de datos

En primer lugar, se extrajeron los datos de las 3 tablas originales y se efectuó una normalización de sus atributos a fin de trabajar con tablas que permitan fácilmente hacer join entre ellas y agrupar eficientemente por *ids*. También se eliminaron los datos de provincia y localidad de la tabla de sucursales dado que no era eficiente extraer el barrio o la comuna por estar dicha información no estructurada (es decir, por figurar como texto libre).

Sin embargo, dado que para cada sucursal se cuenta con el dato de longitud y latitud, se descargaron los *shapes* de los barrios de la página del Gobierno de la Ciudad de Buenos Aires [3]. Estos datos fueron integrados con los datos de sucursales, y mediante operaciones espaciales, se logró ubicar cada sucursal en un barrio de la Ciudad Autónoma de Buenos. A su vez, se construyeron los polígonos correspondientes a las comunas uniendo los polígonos de los barrios que las componen.

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.cap="Barrios y comunas de la Ciudad Autónoma de Buenos Aires"}
gridExtra::grid.arrange(grafico.barrios, grafico.comunas, nrow = 1)
```

Cabe destacar que por un lado se encontraron 3 sucursales que están fuera del polígono de la Ciudad de Buenos Aires, dado que sus domicilios forman parte de partidos aledaños de la Provicia de Buenos Aires. Con dichas sucursales se procedió a buscar el polígono del barrio más cercano para resolver este conflicto. Otro detalle que es importante resaltar es que de las 837 sucursales, solamente 175 de ellas presentan datos de precios en este set de datos analizado.

También se crearon tablas para identificar los comercios (o empresas) y las *banderas* (o unidades de negocio) de dichos comercios. Por ejemplo, INC S.A. es la empresa que agrupa a Hipermercados Carrefour, Carrefour Market y Carrefour Express. Esto nos permite analizar por separado cada bandera dado que, como se verá después, la evolución de los precios no es la misma para banderas de la misma empresa. Como resultado, se obtiene el siguiente esquema de tablas:

   tabla      | descripción                                                     | tipo de objeto
   -----------|-----------------------------------------------------------------|-------------------------
      comunas | comunas de la Ciudad de Buenos Aires                            | data frame geolocalizado
      barrios | barrios de la Ciudad de Buenos Aires                            | data frame geolocalizado
    productos | productos relevados por la aplicación                           | data frame
    comercios | empresas cuyas sucursales fueron relevadas                      | data frame
     banderas | unidades de negocio correspondientes a cada empresa             | data frame
   sucursales | sucursales relevadas en los distintos barrios de CABA           | data frame
      precios | precios por producto y sucursal para cada una de las mediciones | data frame

A continuación, se analizó la tabla de *precios* a fin de detectar si había datos atípicos que pudieran entorpecer en análisis. Dado que los precios varían con los productos y con las mediciones, lo que se hizo para evitar esta complicación fue estandarizar los datos mediante el uso de *z-score*. Se calculó un *z-score* por producto y otro por producto y medición. 

Tomando como base el *z-score* de los precios por producto y medición, se buscaron aquellos datos que resultaran ser *outliers extremos* mediante el método univariado basado en cuartiles (Q1 y Q3) y rango intercualtil. Se consideraron datos atípicos aqullos que estuvieran a una distancia de 3 rangos intercuartiles de Q1 o Q3. Con este sencillo método se eliminaron datos muy distorsivos que representaban aproximadamente el 0,4% de la muestra. Debido a que la cantidad de datos restante resultó ser muy elevada, no se efectuó ningún proceso de imputación de datos faltantes por considerarse innecesario.

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.cap="Boxplots de scores de precios por producto y medición"}
gridExtra::grid.arrange(grafico.outliers.inicial, grafico.outliers.final, ncol = 1)
```

Finalmente, se procedió a dar inicio a los análisis propuestos en los objetivos a partir de este conjunto de datos normalizado, geolocalizado y con precios estandarizados sin valores ruidosos.

# Análisis realizados

## Análisis exploratorio inicial

En esta subsección se explora la distribución de los datos relevados, tanto a nivel espacial como a nivel temporal. El propósito es poder determinar si todos los barrios/comunas fueron relevados de forma homogénea y si dichos relevamientos también fueron homogéneos en el tiempo. Tal como se explicó previamente, sabemos que solamente 175 de las 837 sucursales poseen datos relevados para estas 10 mediciones. Este dato nos hace inferir a priori que pueden existir inhomogeneidades en cuanto a las sucursales y cantidad de precios relevados por barrio. Conocer esta información nos permitirá sacar mejores conclusiones posteriormente.

### ¿Cómo es la distribución espacial de sucursales de acuerdo a la cantidad y tipo de sucursal?

En la figura siguiente se muetran coloreados los barrios y comunas de acuerdo a la cantidad de sucursales relevadas en cada una de las zonas. Es notable observar que hay barrios que no poseen sucursales relevadas. En líneas generales, son barrios del sur de la Ciudad de Buenos Aires. Los barrios que cuentas con mayor cantidad de sucursales relevadas con Palermo y Caballito. A su vez, si agrupamos las sucursales por comuna, ser observa claramente que las comunas del norte tiene mayor cantidad de sucursales relevadas que las comunas del sur.

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=9, fig.cap="Cantidad de sucursales relevadas de la Ciudad Autónoma de Buenos Aires. Los barrios que aparecen en blanco son aquellos donde no hubo relevamiento de precios."}
gridExtra::grid.arrange(grafico.sucursales.barrio, grafico.sucursales.comuna, nrow = 1)
```

También podemos observar que para todas las comunas, la mayoría de las sucursales relevadas corresponden a *supermercados*. En general, hay un 74% de sucursales que son *supermercados* y 26% que son *hipermercados*. Es notable que ninguna de las sucursales relevadas es *autoservicio* (la tercer tipificación de sucursales según el conjunto de datos provisto). Esa proporción varía por comuna sin patrón aparente, aunque en general la mayoría de las comunas mantiene una relación aoximada de 3 a 1 en cuanto a la cantidad de supermercados por hipermercado relevado.

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=5, fig.cap="Proporción de sucursales por tipo para cada comuna de la Ciudad Autónoma de Buenos Aires."}
gridExtra::grid.arrange(grafico.sucursales.tipo.comuna)
```

### ¿Cuál es la cantidad de datos relevados por barrio/comuna? ¿Existe alguna relación con la cantidad de sucursales relevadas?

A continuación se analizó la cantidad de datos relevados por barrio y comuna con el objetivo de ver si se encontraba el mismo patrón que con la cantidad de sucursales o si se había intentado equiparar esta inhomogeneidad relevando más productos en barrios con menor cantidad de sucursales. En la figura siguiente se observa que el patrón de datos relevados es consistentente con el de sucursales relevadas.

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=9, fig.height=5, fig.cap="Cantidad de datos relevados para la Ciudad Autónoma de Buenos Aires. Los barrios que aparecen en blanco son aquellos donde no hubo relevamiento de precios."}
gridExtra::grid.arrange(grafico.precios.barrio, grafico.precios.comuna, nrow = 1)
```

Para reforzar este argumento, también se calculó la proporción de precios relevados sobre la cantidad de sucursales. Se observa que en general esa proporción es más o menos constante, excepto en dos comunas del sur de la Ciudad de Buenos Aires, donde es menor. De todos modos, este patrón es mucho más regular y no parece haber un gradiente notorio con en los casos anteriores (para sucursales y precios).

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=5, fig.cap="Proporción de sucursales por tipo para cada comuna de la Ciudad Autónoma de Buenos Aires."}
gridExtra::grid.arrange(grafico.precios.sucursales.comuna)
```

### ¿Son uniformes en cuanto a duración los períodos de medición? ¿Y con respecto a la cantidad de datos?

Finalmente, para cerrar la etapa de análisis exploratorio, se analizó la distribución temporal de mediciones. El período completo abarca casi 4 meses completos, iniciándose el 5 de Noviembre de 2018 y finalizando el 2 de Marzo de 2019. Esto nos permite realizar una aproximación razonable y considerar los meses completos desde Noviembre de 2018 a Febrero de 2019 para realizar una comparación contra estadísticas oficiales.

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=9, fig.cap="Duración de períodos de medición y cantidad de datos relevados en cada uno de ellos."}
gridExtra::grid.arrange(grafico.cantidad.datos.relevados)
```

En la figura anterior se presentan barras correspondientes a cada medición. Se observan que en general cada medición tiene aproximadamente la misma cantidad de precios relevados, a excepción de la sexta. El ancho de cada barra es proporcional al tiempo de duración de la medición asociada. En este caso se observa que la duración de las mediciones es bastante inhomogénea y que además a los intervalos de tiempo entre ellas también es inhomogéneo. Por ejemplo, entre el inicio de la quinta y la séptima medición, hay casi un mes de diferencia, lo que representa el 25% del intervalo relevado. Esto puede deberse probablemente al período vacacional. Esta información será de considerada al momento de analizar variaciones de precios o comparaciones con estadísticas oficiales.

## Ranking de precios

En esta subsección se exploran los precios a lo largo de todo el período de análisis. El objetivo es encontrar patrones que nos permitan detectar precios más altos o más bajos independientemente del porcentaje evolutivo de los mismos. Se explorarán las sucursales con precios más altos y bajos de la Cuidad y luego se realizará el mismo análisis a nivel de unidades de negocios. Finalmente, se explorará el nivel de precios a nivel de comunas para tratar de encontrar algún patrón emergente.

En el análisis de precios a nivel de sucursales, se utilizó el z-score de los precios por producto para todo el período. Esto nos permite comparar precios de productos diferentes en todo el intervalo de tiempo. Para los análisis de precios por comercio y por comuna, se utilizó el z-score de precios por producto y por medición. Esto nos permite comparar el precio de productos diferentes y su evolución a lo largo de cada medición.

### ¿Cuáles son las sucursales con precios más altos y más bajos a lo largo de todo el período?

Las tablas que se muestran a continuación muestran las 5 sucursales con precios más altos y bajos, respectivamente, a lo largo de todo el período de análisis. Es de interés para el consumidor, dado que esta información puede modificar hábitos de compra. Esta información también motiva un posterior análisis por comercio. Como ya se observa en las siguientes tablas, las sucursales con precios más baratos son todas unidades de negocio de INC S.A., mientras que las que tienen precios más elevados son de Jumbo Retail Argentina S.A.

__Sucursales con precios más bajos__:

```{r, echo=FALSE, warnings=FALSE, message=FALSE }
sucursales.mas.baratas <- sf::st_set_geometry(zscore.precios.sucursal, NULL)
knitr::kable(
  x = sucursales.mas.baratas[1:5,] %>%
    dplyr::inner_join(sf::st_set_geometry(barrios, NULL), by = c("barrioId")) %>%
    dplyr::rename(barrio = nombre) %>%
    dplyr::inner_join(banderas, by = c("comercioId", "banderaId")) %>%
    dplyr::rename(bandera = descripcion) %>%
    dplyr::inner_join(comercios, by = c("comercioId")) %>%
    dplyr::rename(razon_social = razonSocial) %>%
    dplyr::select(razon_social, bandera, direccion, zscore_precio_mediana),
  col.names = c("Razón social", "Bandera", "Domicilio", "Z-score (mediana)"),
  digits = 3
)
```

__Sucursales con precios más elevados__:

```{r, echo=FALSE, warnings=FALSE, message=FALSE }
sucursales.mas.caras <- sf::st_set_geometry(zscore.precios.sucursal, NULL) %>%
  dplyr::arrange(dplyr::desc(zscore_precio_mediana))
knitr::kable(
  x = sucursales.mas.caras[1:5,] %>%
    dplyr::inner_join(sf::st_set_geometry(barrios, NULL), by = c("barrioId")) %>%
    dplyr::rename(barrio = nombre) %>%
    dplyr::inner_join(banderas, by = c("comercioId", "banderaId")) %>%
    dplyr::rename(bandera = descripcion) %>%
    dplyr::inner_join(comercios, by = c("comercioId")) %>%
    dplyr::rename(razon_social = razonSocial) %>%
    dplyr::select(razon_social, bandera, direccion, zscore_precio_mediana),
  col.names = c("Razón social", "Bandera", "Domicilio", "Z-score (mediana)"),
  digits = 3
)
```

### ¿Cuáles son las empresas con precios más altos y más bajos?

La información anterior sirve como disparador para preguntarnos cuáles son los comercios con precios más altos y bajos de los relevados. A fin de responder esta pregunta, se elabora un mapa de calor. En el eje de las abcisas se muestran las 10 mediciones realizadas y en el de las ordenadas, las 11 unidades de negocios cuyas sucursales fueron relevadas (existen en realidad 15 unidades de negocio, pero tal como se explicó previamente, la mayoría de las sucursales listadas no poseen datos de precios para el período de análisis). 

Luego se elaboró un ranking del 1 (comercio con precios más bajos) y 11 (sucursal con precios más elevados) utilizando la mediana de los z-score de los precios de los productos para cada sucursal en cada medición. Como se observa, *Supermercados DIA* es el comercio que más veces aparece como el que tiene los precios más bajos. Sin embargo, lo siguen de cerca (e incluso lo superan en algunas mediciones) *Hipermercados Carrefour* y *Carrefour Market*. Por el contrario, los comercios con precios más elevados son las 3 unidades de negocios de *Jumbo Retail Argentina* (Jumbo, Disco y Vea).

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=9, fig.height=6, fig.cap="Ranking de precios por comercios a lo largo del período de relevamiento (valores más bajos de ranking indican comercios con precios más baratos)"}
plot(grafico.ranking.precios.comercio)
```

### ¿Cuáles son las comunas con precios más altos y más bajos? 

Por último, para finalizar esta subsección, se elabora un ranking de precios por comuna y medición. El análisis es análogo al de precios por comercio y medición. En vez de agrupar las sucursales por unidad de negocio, en este caso se agrupan por la comuna a la que pertenencen. En líneas generales se observa que las comunas del norte de la Ciudad de Buenos Aires tienen precios más elevados que aquellas ubicadas en la zona sur, aunque con excepciones. Es notable observar que la Comuna 6, correspondiente al barrio de Caballito resulta ser aquella que tiene las sucursales con precios más elevados de acuerdo a los datos relevados.

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=9, fig.height=6, fig.cap="Scores de precios por comuna a lo largo del período de relevamiento"}
plot(grafico.scores.precios.comunas)
```

## Evolución temporal de precios

### ¿Es consistente la evolución de precios con los datos del IPC informado por el Gobierno de la Ciudad de Buenos Aires? ¿Hay alguna diferencia según el tipo de sucursal?

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=9, fig.cap="Comparación de incrementos porcentuales registrados en los productos relevados contra valores de IPC (GCBA) publicados para el período Noviembre-2018 a Febrero de 2019. Se ha comparado la variación de precio de cada producto en cada sucursal tomando entre la primera y la última medición."}
gridExtra::grid.arrange(grafico.evolucion.general)
```

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=9, fig.height=5, fig.cap="Incrementos porcentuales registrados en los productos relevados agrupados por tipo de sucursal. Se ha comparado la variación de precio de cada producto en cada sucursal tomando entre la primera y la última medición."}
gridExtra::grid.arrange(grafico.boxplots.evolucion.por.tipo.sucursal)
```

### ¿Cuál es la evolución porcentual de precios por comuna?

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=9, fig.height=5, fig.cap="Incrementos porcentuales registrados en los productos relevados agrupados por comuna. Se ha comparado la variación de precio de cada producto en cada sucursal tomando entre la primera y la última medición. Se presentan los valores de media y mediana para cada comuna."}
gridExtra::grid.arrange(grafico.mediana.evolucion.por.comuna, grafico.media.evolucion.por.comuna, ncol = 2)
```

### ¿Cuál fue le evolución de precios según la empresa?

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=9, fig.height=5, fig.cap="Incrementos porcentuales registrados en los productos relevados agrupados por comercio. Se ha comparado la variación de precio de cada producto en cada sucursal tomando entre la primera y la última medición. Se presentan los valores de media y mediana para cada comercio."}
gridExtra::grid.arrange(grafico.evolucion.por.comercio)
```

### ¿Cuáles fueron los productos cuya evolución fue máxima y mínima? ¿Y los que fueron más estables?

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=10, fig.height=6, fig.cap="Incrementos porcentuales registrados en los productos. Se muestran 3 categorías y 5 productos por cada una de ellas: productos con máxima o mayor variación, productos más estables (con variación más cercana a 0) y productos con mínima o menor variación."}
gridExtra::grid.arrange(grafico.evolucion.por.producto)
```

# Conclusiones

# Referencias

[1]   Precios Claros (https://www.preciosclaros.gob.ar)

[2]   Patil Y, Patil S. Review of Web Crawlers with Specification and Working, 2016 (https://www.ijarcce.com/upload/2016/january-16/IJARCCE%2052.pdf)

[3]   Límites y ubicación geográfica de los barrios de la Ciudad, Buenos Aires Ciudad (https://data.buenosaires.gob.ar/dataset/barrios)
