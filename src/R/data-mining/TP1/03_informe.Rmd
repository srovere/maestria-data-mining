---
title: "Data Mining: Trabajo Práctico nº 1"
subtitle: "Análisis de set de datos de Precios Claros"
author:
- Santiago Rovere (srovere@gmail.com), Facultad de Ingeniería, Universidad de Buenos Aires
- Javier Quinteros (jaqbase-dmkm@yahoo.com.ar), Universidad Argentina de la Empresa
date: '`r format(Sys.Date(), "%d de %B de %Y")`'
output:
  html_document:
    number_sections: yes
  pdf_document:
    number_sections: yes
  html_notebook:
    number_sections: yes
header-includes: \usepackage{float}
lang: es
---

```{r, echo=FALSE, warnings=FALSE, message=FALSE }
# Borrar bariables del ambiente
rm(list = objects())

# Carga de paquetes necesarios para hacer los gráficos
require(Cairo)
require(ggplot2)
require(gridExtra)
require(knitr)
require(sf)

# Uso de Cairo para renderizar los gráficos
options(bitmapType = "cairo")

# Ubicar los gráficos en el lugar donde aparece el código
knitr::opts_chunk$set(fig.pos = "H", collapse = TRUE)

# Carga de variables necesarias para realizar el informe
load(file = paste0("input/PreciosClaros.RData"))
load(file = paste0("output/GraficosPreparacion.RData"))
load(file = paste0("output/Informe.RData"))
```

# Introducción

El presente trabajo se basa en la exploración y análisis de un conjunto de datos extraído del la aplicación **Precios Claros** [1]. Dichos datos fueron extraídos mediante un proceso de relevamiento automático utilizando la técnica de web crawling [2]. Este proceso consistió en la en la generación de consultas a la página web mediante un script programado en *Python*. Cada medición tomó 3 semanas aproximadamente debido a la gran cantidad de datos disponibles y la cantidad máxima de consultas por día que se pueden hacer al sitio sin ser bloqueado. Sea realizaron un total de 10 mediciones.

Posteriormente, este conjunto de datos fue introducido en una base de datos MongoDB a fin de poder manejar más cómodamente las consultas. El set de datos inicial es el siguiente:

   tabla      | descripción                                                       | cantidad de datos
   -----------|-------------------------------------------------------------------|------------------
    productos | productos relevados por la aplicación                             | 1.000
   sucursales | sucursales relevadas en los distintos barrios de CABA             | 837
      precios | precios por producto y sucursal para cada una de las mediciones   | + 1,5 millones
      
Este documento se organiza de la siguiente manera: en la sección *2* se presentarán los objetivos de este estudio en forma de preguntas a responder; en la sección *3* se detallará el proceso de preparación de datos que se realizó a fin de poder llevar a cabo los análisis de la sección *4*; finalmente, en la sección *5* se elaborarán las conclusiones finales del trabajo proponiendo algunas posibles líneas de trabajo futuro.

# Objetivo

En presente trabajo se propone responder una serie de preguntas organizadas en 3 categorías:

* Análisis exploratorio inicial
  - ¿Cómo es la distribución espacial de sucursales de acuerdo a la cantidad y tipo de sucursal?
  - ¿Cuál es la cantidad de datos relevados por barrio/comuna? ¿Existe alguna relación con la cantidad de sucursales relevadas?
  - ¿Son uniformes en cuanto a duración los períodos de medición? ¿Y con respecto a la cantidad de datos?

* Ranking de precios 
  - ¿Cuáles son las sucursales con precios más altos y más bajos a lo largo de todo el período?
  - ¿Cuáles son las comunas con precios más altos y más bajos?
  - ¿Cuáles son las empresas con precios más altos y más bajos?
  
* Evolución temporal de precios
  - ¿Es consistente la evolución de precios con los datos del IPC informado por el Gobierno de la Ciudad de Buenos Aires?
  - ¿Cuál es la evolución porcentual de precios por comuna?
  - ¿Cuál es la evolución porcentual de precios por tipo de sucursal?
  - ¿Cuáles fueron las empresas cuya evolución fue máxima y mínima?
  
# Preparación de datos

En primer lugar, se extrajeron los datos de las 3 tablas originales y se efectuó una normalización de sus atributos a fin de trabajar con tablas que permitan fácilmente hacer join entre ellas y agrupar eficientemente por *ids*. También se eliminaron los datos de provincia y localidad de la tabla de sucursales dado que no era eficiente extraer el barrio o la comuna por estar dicha información no estructurada (es decir, por figurar como texto libre).

Sin embargo, dado que para cada sucursal se cuenta con el dato de longitud y latitud, se descargaron los *shapes* de los barrios de la página del Gobierno de la Ciudad de Buenos Aires [3]. Estos datos fueron integrados con los datos de sucursales, y mediante operaciones espaciales, se logró ubicar cada sucursal en un barrio de la Ciudad Autónoma de Buenos. A su vez, se construyeron los polígonos correspondientes a las comunas uniendo los polígonos de los barrios que las componen.

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.cap="Barrios y comunas de la Ciudad Autónoma de Buenos Aires"}
gridExtra::grid.arrange(grafico.barrios, grafico.comunas, nrow = 1)
```

Cabe destacar que por un lado se encontraron 3 sucursales que están fuera del polígono de la Ciudad de Buenos Aires, dado que sus domicilios forman parte de partidos aledaños de la Provicia de Buenos Aires. Con dichas sucursales se procedió a buscar el polígono del barrio más cercano para resolver este conflicto. Otro detalle que es importante resaltar es que de las 837 sucursales, solamente 175 de ellas presentan datos de precios en este set de datos analizado.

A continuación, se analizó la tabla de *precios* a fin de detectar si había datos atípicos que pudieran entorpecer en análisis. Dado que los precios varían con los productos y con las mediciones, lo que se hizo para evitar esta complicación fue estandarizar los datos mediante el uso de *z-score*. Se calculó un *z-score* por porducto y otro por producto y medición. 

Tomando como base el *z-score* de los precios por producto y medición, se buscaron aquellos datos que resultaran ser *outliers extremos* mediante el método univariado basado en cuartiles (Q1 y Q3) y rango intercualtil. Se consideraron datos atípicos aqullos que estuvieran a una distancia de 3 rangos intercuartiles de Q1 o Q3. Con este sencillo método se eliminaron datos muy distorsivos que representaban aproximadamente el 0,4% de la muestra. Debido a que la cantidad de datos restante resultó ser muy elevada, no se efectuó ningún proceso de imputación de datos faltantes por considerarse innecesario.

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.cap="Boxplots de scores de precios por producto y medición"}
gridExtra::grid.arrange(grafico.outliers.inicial, grafico.outliers.final, ncol = 1)
```

Finalmente, se procedió a dar inicio a los análisis propuestos en los objetivos a partir de este conjunto de datos normalizado, geolocalizado y con precios estandarizados sin valores ruidosos.

# Análisis realizados

## Análisis exploratorio inicial

### ¿Cómo es la distribución espacial de sucursales de acuerdo a la cantidad y tipo de sucursal?

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=9, fig.cap="Cantidad de sucursales relevadas de la Ciudad Autónoma de Buenos Aires. Los barrios que aparecen en blanco son aquellos donde no hubo relevamiento de precios."}
gridExtra::grid.arrange(grafico.sucursales.barrio, grafico.sucursales.comuna, nrow = 1)
```

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=5, fig.cap="Proporción de sucursales por tipo para cada comuna de la Ciudad Autónoma de Buenos Aires."}
gridExtra::grid.arrange(grafico.sucursales.tipo.comuna)
```

### ¿Cuál es la cantidad de datos relevados por barrio/comuna? ¿Existe alguna relación con la cantidad de sucursales relevadas?

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=9, fig.height=5, fig.cap="Cantidad de datos relevados para la Ciudad Autónoma de Buenos Aires. Los barrios que aparecen en blanco son aquellos donde no hubo relevamiento de precios."}
gridExtra::grid.arrange(grafico.precios.barrio, grafico.precios.comuna, nrow = 1)
```

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=5, fig.cap="Proporción de sucursales por tipo para cada comuna de la Ciudad Autónoma de Buenos Aires."}
gridExtra::grid.arrange(grafico.precios.sucursales.comuna)
```

### ¿Son uniformes en cuanto a duración los períodos de medición? ¿Y con respecto a la cantidad de datos?

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=9, fig.cap="Duración de períodos de medición y cantidad de datos relevados en cada uno de ellos."}
gridExtra::grid.arrange(grafico.cantidad.datos.relevados)
```

## Ranking de precios

### ¿Cuáles son las sucursales con precios más altos y más bajos a lo largo de todo el período?

Sucursales con precios más bajos

```{r, echo=FALSE, warnings=FALSE, message=FALSE }
sucursales.mas.baratas <- sf::st_set_geometry(zscore.precios.sucursal, NULL)
knitr::kable(
  x = sucursales.mas.baratas[1:5,] %>%
    dplyr::inner_join(sf::st_set_geometry(barrios, NULL), by = c("barrioId")) %>%
    dplyr::rename(barrio = nombre) %>%
    dplyr::inner_join(banderas, by = c("comercioId", "banderaId")) %>%
    dplyr::rename(bandera = descripcion) %>%
    dplyr::inner_join(comercios, by = c("comercioId")) %>%
    dplyr::rename(razon_social = razonSocial) %>%
    dplyr::select(razon_social, bandera, direccion, zscore_precio_mediana),
  col.names = c("Razón social", "Bandera", "Domicilio", "Z-score (mediana)"),
  digits = 3
)
```

Sucursales con precios más elevados

```{r, echo=FALSE, warnings=FALSE, message=FALSE }
sucursales.mas.caras <- sf::st_set_geometry(zscore.precios.sucursal, NULL) %>%
  dplyr::arrange(dplyr::desc(zscore_precio_mediana))
knitr::kable(
  x = sucursales.mas.caras[1:5,] %>%
    dplyr::inner_join(sf::st_set_geometry(barrios, NULL), by = c("barrioId")) %>%
    dplyr::rename(barrio = nombre) %>%
    dplyr::inner_join(banderas, by = c("comercioId", "banderaId")) %>%
    dplyr::rename(bandera = descripcion) %>%
    dplyr::inner_join(comercios, by = c("comercioId")) %>%
    dplyr::rename(razon_social = razonSocial) %>%
    dplyr::select(razon_social, bandera, direccion, zscore_precio_mediana),
  col.names = c("Razón social", "Bandera", "Domicilio", "Z-score (mediana)"),
  digits = 3
)
```

### ¿Cuáles son las comunas con precios más altos y más bajos? 

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=9, fig.height=6, fig.cap="Scores de precios por comuna a lo largo del período de relevamiento"}
plot(grafico.scores.precios.comunas)
```

### ¿Cuáles son las empresas con precios más altos y más bajos?

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=9, fig.height=6, fig.cap="Ranking de precios por comercios a lo largo del período de relevamiento (valores más bajos de ranking indican comercios con precios más baratos)"}
plot(grafico.ranking.precios.comercio)
```

## Evolución temporal de precios

### ¿Es consistente la evolución de precios con los datos del IPC informado por el Gobierno de la Ciudad de Buenos Aires?

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=9, fig.cap="Comparación de incrementos  porcentuales registrados en los productos relevados contra valores de IPC (GCBA) publicados para el período Noviembre-2018 a Febrero de 2019. Se ha comparado la variación de precio de cada producto en cada sucursal tomando entre la primera y la última medición."}
gridExtra::grid.arrange(grafico.evolucion.general)
```

### ¿Cuál es la evolución porcentual de precios por comuna?

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=9, fig.height=5, fig.cap="Incrementos  porcentuales registrados en los productos relevados agrupados por comuna. Se ha comparado la variación de precio de cada producto en cada sucursal tomando entre la primera y la última medición. Se presentan los valores de media y mediana para cada comuna."}
gridExtra::grid.arrange(grafico.mediana.evolucion.por.comuna, grafico.media.evolucion.por.comuna, ncol = 2)
```

### ¿Cuál es la evolución porcentual de precios por tipo de sucursal?

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=9, fig.height=5, fig.cap="Incrementos  porcentuales registrados en los productos relevados agrupados por tipo de sucursal. Se ha comparado la variación de precio de cada producto en cada sucursal tomando entre la primera y la última medición."}
gridExtra::grid.arrange(grafico.boxplots.evolucion.por.tipo.sucursal)
```

### ¿Cuáles fueron las empresas cuya evolución fue máxima y mínima?

```{r, echo=FALSE, warnings=FALSE, message=FALSE, results='asis', fig.align='center', fig.width=9, fig.height=5, fig.cap="Incrementos  porcentuales registrados en los productos relevados agrupados por comercio. Se ha comparado la variación de precio de cada producto en cada sucursal tomando entre la primera y la última medición. Se presentan los valores de media y mediana para cada comercio."}
gridExtra::grid.arrange(grafico.evolucion.por.comercio)
```

# Conclusiones

# Referencias

[1]   Precios Claros (https://www.preciosclaros.gob.ar)

[2]   Patil Y, Patil S. Review of Web Crawlers with Specification and Working, 2016 (https://www.ijarcce.com/upload/2016/january-16/IJARCCE%2052.pdf)

[3]   Límites y ubicación geográfica de los barrios de la Ciudad, Buenos Aires Ciudad (https://data.buenosaires.gob.ar/dataset/barrios)
