---
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
output: pdf_document
title: 'Sistemas de información geográfica: Trabajo Práctico nº 1'
subtitle: 'Análisis del acceso a la educación primaria en la Ciudad de Buenos Aires'
author: 
  - Aprea, Mariano
  - Estrin, Hernán
  - Pecina, Lucas
  - Rovere, Santiago (srovere@gmail.com)
lang: es
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, results=FALSE }
# Borrar variables del ambiente
rm(list = objects())

# Carga de paquetes necesarios para hacer los gráficos
require(Cairo)
require(sf)
require(tidyverse)

# Uso de Cairo para renderizar los gráficos
options(bitmapType = "cairo")

# Cargar datos de barrios
barrios <- sf::st_read(dsn = "data", layer = "barrios_badata") %>%
  dplyr::mutate(barrio_id = dplyr::row_number(), area = AREA/1000000) %>%
  dplyr::rename(comuna = COMUNA, nombre = BARRIO) %>%
  dplyr::select(barrio_id, comuna, nombre, area)

# Cargar datos de establecimientos y determinar a que barrio pertenece cada uno de ellos
# Me quedo con las escuelas estatales de nivel primario
establecimientos <- sf::st_read(dsn = "data", layer = "establecimientos-educativos") %>%
  dplyr::mutate(barrio_id = as.integer(unlist(sf::st_intersects(., barrios)))) %>%
  dplyr::filter(SECTOR == 1 & stringr::str_detect(string = NIVMOD, pattern = "PriCom")) 

# Cargar datos censales, pasar a proyeccion planar y determinar a que barrio pertenece cada uno de ellos
# Dado que los radios censales estan incluidos dentro de un barrio, entonces para evitar problemas de proyeccion
# se determinarar el barrio en base a la ubicacion del centroide. Se utiliza st_nearest_feature porque para
# 4 casos en particular, el centroide cae fuera del poligono de barrios (por los "huecos" que tiene)
# Como el archivo de censos tiene mal 2 poligonos, los extraigo del geojson y luego hago join con los datos censales.
radios.censales <- geojsonsf::geojson_sf("data/caba_radios_censales.geojson") %>%
  sf::st_transform(crs = sf::st_crs(barrios)) %>%
  dplyr::select(-BARRIO)
datos.censales <- sf::st_read(dsn = "data", layer = "censo_2010_caba") %>%
  sf::st_transform(crs = sf::st_crs(barrios)) %>%
  dplyr::select(CO_FRAC_RA, T_VARON, T_MUJER, T_VIVIENDA, V_PARTICUL, V_COLECTIV) %>%
  dplyr::rename(RADIO_ID = CO_FRAC_RA) %>%
  sf::st_set_geometry(NULL)
censo <- dplyr::inner_join(radios.censales, datos.censales, by = c("RADIO_ID"))
centroides.radios.censales <- sf::st_centroid(censo) %>%
  dplyr::mutate(barrio_id = as.integer(sf::st_nearest_feature(., barrios))) %>%
  sf::st_set_geometry(NULL) %>%
  dplyr::select(RADIO_ID, barrio_id) %>%
  dplyr::filter(! is.na(barrio_id))
censo <- censo %>%
  dplyr::inner_join(centroides.radios.censales, by = "RADIO_ID")
rm(radios.censales, datos.censales, centroides.radios.censales)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, results=TRUE }
# Porcentaje de hogares con NBI
resumen.barrio <- censo %>%
  sf::st_set_geometry(NULL) %>%
  dplyr::group_by(barrio_id) %>%
  dplyr::summarise(total_hogares = sum(HOGARES), total_hogares_nbi = sum(HOGARES_NBI)) %>%
  dplyr::mutate(porcentaje_nbi = 100 * total_hogares_nbi / total_hogares)
porcentaje.nbi.barrio <- barrios %>%
  dplyr::inner_join(resumen.barrio, by = c("barrio_id"))

ggplot2::ggplot() +
  ggplot2::geom_sf(data = porcentaje.nbi.barrio, colour = "black",
                   mapping = ggplot2::aes(fill = porcentaje_nbi)) +
  ggplot2::labs(x = "", y = "", title = "Porcentaje de hogares con NBI",
                subtitle = "",
                fill = "Porcentaje") +
  ggplot2::scale_fill_distiller(type = "seq", palette = "YlOrRd", direction = 1) +
  ggplot2::theme_bw() +
  ggplot2::theme(
    plot.title = ggplot2::element_text(hjust = 0.5),
    plot.subtitle = ggplot2::element_text(hjust = 0.5),
    panel.grid.major = ggplot2::element_blank(),
    axis.text.x = ggplot2::element_blank(),
    axis.ticks.x = ggplot2::element_blank(),
    axis.text.y = ggplot2::element_blank(),
    axis.ticks.y = ggplot2::element_blank(),
    strip.text.x = ggplot2::element_blank(),
    strip.background = ggplot2::element_rect(colour = "white", fill = "white"),
    legend.position = "right",
    legend.background = ggplot2::element_rect(fill = "grey90", size = 0.1, linetype = "solid", colour = "black")
  ) + ggplot2::guides(fill = ggplot2::guide_colourbar(barheight = 10))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, results=TRUE }
# Mapas de establecimientos por km2 de cada barrio
establecimientos.por.barrio <- establecimientos %>%
  sf::st_set_geometry(NULL) %>%
  dplyr::group_by(barrio_id) %>%
  dplyr::summarise(cantidad = dplyr::n())
establecimientos.por.barrio <- barrios %>%
  dplyr::inner_join(establecimientos.por.barrio, by = c("barrio_id")) %>%
  dplyr::mutate(densidad = cantidad / area)

ggplot2::ggplot() +
  ggplot2::geom_sf(data = establecimientos.por.barrio, colour = "black",
                   mapping = ggplot2::aes(fill = densidad)) +
  ggplot2::labs(x = "", y = "", title = "Establecimientos educativos por barrio",
                subtitle = "Densidad por km²",
                fill = "Densidad") +
  ggplot2::scale_fill_distiller(type = "seq", palette = "YlOrRd", direction = 1) +
  ggplot2::theme_bw() +
  ggplot2::theme(
    plot.title = ggplot2::element_text(hjust = 0.5),
    plot.subtitle = ggplot2::element_text(hjust = 0.5),
    panel.grid.major = ggplot2::element_blank(),
    axis.text.x = ggplot2::element_blank(),
    axis.ticks.x = ggplot2::element_blank(),
    axis.text.y = ggplot2::element_blank(),
    axis.ticks.y = ggplot2::element_blank(),
    strip.text.x = ggplot2::element_blank(),
    strip.background = ggplot2::element_rect(colour = "white", fill = "white"),
    legend.position = "right",
    legend.background = ggplot2::element_rect(fill = "grey90", size = 0.1, linetype = "solid", colour = "black")
  ) + ggplot2::guides(fill = ggplot2::guide_colourbar(barheight = 10))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, results=TRUE }
# Mapas de poblacion por establecimientos de cada barrio
establecimientos.por.barrio <- establecimientos %>%
  sf::st_set_geometry(NULL) %>%
  dplyr::group_by(barrio_id) %>%
  dplyr::summarise(cantidad = dplyr::n())
hogares.nbi.por.barrio <- censo %>%
  sf::st_set_geometry(NULL) %>%
  dplyr::group_by(barrio_id) %>%
  dplyr::summarise(hogares = sum(HOGARES_NBI))
hogares.nbi.por.establecimiento.barrio <- barrios %>%
  dplyr::inner_join(establecimientos.por.barrio, by = c("barrio_id")) %>%
  dplyr::inner_join(hogares.nbi.por.barrio, by = c("barrio_id")) %>%
  dplyr::mutate(hogares_establecimiento = hogares / cantidad)

ggplot2::ggplot() +
  ggplot2::geom_sf(data = hogares.nbi.por.establecimiento.barrio, colour = "black",
                   mapping = ggplot2::aes(fill = hogares_establecimiento)) +
  ggplot2::labs(x = "", y = "", title = "Hogares NBI por establecimientos educativos",
                subtitle = "",
                fill = "Hogares") +
  ggplot2::scale_fill_distiller(type = "seq", palette = "YlOrRd", direction = 1) +
  ggplot2::theme_bw() +
  ggplot2::theme(
    plot.title = ggplot2::element_text(hjust = 0.5),
    plot.subtitle = ggplot2::element_text(hjust = 0.5),
    panel.grid.major = ggplot2::element_blank(),
    axis.text.x = ggplot2::element_blank(),
    axis.ticks.x = ggplot2::element_blank(),
    axis.text.y = ggplot2::element_blank(),
    axis.ticks.y = ggplot2::element_blank(),
    strip.text.x = ggplot2::element_blank(),
    strip.background = ggplot2::element_rect(colour = "white", fill = "white"),
    legend.position = "right",
    legend.background = ggplot2::element_rect(fill = "grey90", size = 0.1, linetype = "solid", colour = "black")
  ) + ggplot2::guides(fill = ggplot2::guide_colourbar(barheight = 10))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, comment=FALSE, results=TRUE }
# Distancia mínima de un radio censal a un establecimiento educativo
distancias.radios.establecimientos <- sf::st_distance(censo, establecimientos)
distancias.minimas                 <- censo %>%
  dplyr::mutate(distancia_minima = apply(distancias.radios.establecimientos, MARGIN = 1, FUN = min),
                porcentaje_nbi = 100 * HOGARES_NBI / HOGARES)
```